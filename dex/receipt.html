<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Receipt</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- html2canvas library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --status-success: #10B981;
            --status-failed: #EF4444;
            --status-pending: #F59E0B;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="receipt-root"
        class="w-full max-w-md bg-white shadow-2xl rounded-3xl overflow-hidden relative border border-gray-100">

        <!-- Status Header -->
        <div id="status-header" class="bg-amber-50 p-8 text-center border-b border-dashed border-gray-200 relative overflow-hidden">
            <!-- Decorative circle -->
            <div id="status-circle"
                class="absolute top-[-50px] left-[-50px] w-32 h-32 rounded-full opacity-50 blur-2xl bg-amber-100"></div>

            <div id="status-icon-wrap"
                class="mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4 shadow-sm ring-4 ring-white relative z-10 bg-amber-100">
                <i id="status-icon" class="fas fa-spinner text-3xl text-amber-500 animate-spin"></i>
            </div>
            <h1 id="status-text" class="text-2xl font-bold text-gray-800 tracking-tight">Payment Pending</h1>
            <p id="status-timestamp" class="text-sm text-gray-500 mt-1 font-medium"></p>

            <div class="mt-6">
                <span id="amount" class="text-4xl font-extrabold text-gray-900 tracking-tighter"></span>
                <span id="symbol" class="text-lg font-bold text-gray-500"></span>
            </div>
            <div
                class="inline-block mt-2 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs font-semibold text-gray-600 shadow-sm">
                <i class="fas fa-exchange-alt mr-1 text-blue-500"></i> DEX Transaction
            </div>
        </div>

        <!-- Ticket Body -->
        <div class="p-6 space-y-6">

            <!-- Service Details Section -->
            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                <div class="flex items-center space-x-3 mb-4 border-b border-gray-200 pb-3">
                    <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                        <i class="fas fa-mobile-alt text-red-500 text-sm"></i>
                    </div>
                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Service Details</h3>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-start">
                        <span class="text-gray-500">Service</span>
                        <span id="service" class="font-semibold text-gray-900 text-right"></span>
                    </div>
                    <div class="flex justify-between items-start">
                        <span class="text-gray-500">Provider</span>
                        <span id="provider" class="font-semibold text-gray-900 text-right"></span>
                    </div>
                    <div class="flex justify-between items-start">
                        <span class="text-gray-500">Recipient</span>
                        <span id="recipient" class="font-semibold text-gray-900 text-right"></span>
                    </div>
                    <div class="flex justify-between items-start">
                        <span class="text-gray-500">Value Received</span>
                        <span id="fiatValue" class="font-bold text-green-600 text-right"></span>
                    </div>
                    <div class="flex justify-between items-start pt-2 border-t border-gray-200 border-dashed">
                        <span class="text-gray-500">Reference</span>
                        <div class="flex items-center space-x-2">
                            <span id="reference" class="font-mono text-gray-700 text-xs"></span>
                            <button id="reference-copy" class="text-gray-400 hover:text-blue-500 transition-colors">
                                <i class="far fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- On-Chain Details Section -->
            <div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1 flex items-center">
                    <i class="fas fa-link mr-2"></i> On-Chain Data
                </h3>

                <div class="space-y-4">
                    <!-- Token Info -->
                    <div class="flex justify-between items-center group">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-teal-50 flex items-center justify-center text-teal-600">
                                <i class="fas fa-coins text-sm"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-500">Token</span>
                                <span id="token-symbol" class="text-sm font-medium text-gray-900"></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span id="token-short" class="text-xs text-gray-400 font-mono block w-24 truncate"></span>
                        </div>
                    </div>

                    <!-- Sender Info -->
                    <div class="flex justify-between items-center group">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                                <i class="fas fa-wallet text-sm"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-500">Sender</span>
                                <span id="sender-short" class="text-sm font-medium text-gray-900"></span>
                            </div>
                        </div>
                        <button id="sender-copy"
                            class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 transition-colors">
                            <i class="far fa-copy text-sm"></i>
                        </button>
                    </div>

                    <!-- Target Info -->
                    <div class="flex justify-between items-center group">
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-8 h-8 rounded-lg bg-purple-50 flex items-center justify-center text-purple-600">
                                <i class="fas fa-bullseye text-sm"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-500">Target</span>
                                <span id="target-short" class="text-sm font-medium text-gray-900"></span>
                            </div>
                        </div>
                        <button id="target-copy"
                            class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 transition-colors">
                            <i class="far fa-copy text-sm"></i>
                        </button>
                    </div>

                    <!-- Transaction Hash -->
                    <div class="bg-gray-900 rounded-xl p-3 shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400">Transaction Hash</span>
                            <div class="flex items-center space-x-2">
                                <span id="tx-status-dot" class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></span>
                                <span id="tx-status-text" class="text-xs text-amber-400 font-medium">Pending</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <code id="tx-hash" class="text-xs text-gray-300 font-mono break-all mr-2"></code>
                            <button id="tx-copy"
                                class="text-gray-400 hover:text-white transition-colors text-xs bg-gray-800 px-2 py-1 rounded">
                                Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="p-4 bg-gray-50 border-t border-gray-100 flex space-x-3">
            <button id="save-image-btn"
                class="flex-1 py-3 rounded-xl bg-white border border-gray-200 text-gray-700 font-semibold shadow-sm hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-image"></i> Save Image
            </button>
            <button id="print-btn"
                class="flex-1 py-3 rounded-xl bg-gray-900 text-white font-semibold shadow-lg hover:bg-gray-800 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

    <script>
        // Utility Functions
        function formatShort(addr) {
            if (!addr || addr.length < 10) return addr || '';
            return addr.slice(0, 6) + '...' + addr.slice(-4);
        }
        
        function qs(key, def) {
            const u = new URLSearchParams(window.location.search);
            return u.get(key) || def;
        }
        
        function copyToClipboard(text, label) {
            // Create a temporary input element
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert(label + ' copied to clipboard.');
        }
        
        function resolveStatus(raw) {
            const s = String(raw || 'pending').trim().toLowerCase();
            if (['success', 'ok', 'confirmed'].includes(s)) return 'success';
            if (['failed', 'error', 'fail'].includes(s)) return 'failed';
            return 'pending';
        }

        function setStatusFromQuery() {
            const status = resolveStatus(qs('status', 'pending'));
            const header = document.getElementById('status-header');
            const circle = document.getElementById('status-circle');
            const iconWrap = document.getElementById('status-icon-wrap');
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-text');
            const dot = document.getElementById('tx-status-dot');
            const dotText = document.getElementById('tx-status-text');

            if (status === 'success') {
                header.className = 'bg-green-50 p-8 text-center border-b border-dashed border-gray-200 relative overflow-hidden';
                circle.className = 'absolute top-[-50px] left-[-50px] w-32 h-32 rounded-full opacity-50 blur-2xl bg-green-100';
                iconWrap.className = 'mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4 shadow-sm ring-4 ring-white relative z-10 bg-green-100';
                icon.className = 'fas fa-check text-3xl';
                icon.style.color = 'var(--status-success)';
                icon.classList.remove('animate-spin');
                title.textContent = 'Payment Successful';
                dot.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
                dotText.className = 'text-xs text-green-400 font-medium';
                dotText.textContent = 'Confirmed';
            } else if (status === 'failed') {
                header.className = 'bg-red-50 p-8 text-center border-b border-dashed border-gray-200 relative overflow-hidden';
                circle.className = 'absolute top-[-50px] left-[-50px] w-32 h-32 rounded-full opacity-50 blur-2xl bg-red-100';
                iconWrap.className = 'mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4 shadow-sm ring-4 ring-white relative z-10 bg-red-100';
                icon.className = 'fas fa-xmark text-3xl';
                icon.style.color = 'var(--status-failed)';
                icon.classList.remove('animate-spin');
                title.textContent = 'Payment Failed';
                dot.className = 'w-2 h-2 rounded-full bg-red-500';
                dotText.className = 'text-xs text-red-400 font-medium';
                dotText.textContent = 'Failed';
            } else {
                header.className = 'bg-amber-50 p-8 text-center border-b border-dashed border-gray-200 relative overflow-hidden';
                circle.className = 'absolute top-[-50px] left-[-50px] w-32 h-32 rounded-full opacity-50 blur-2xl bg-amber-100';
                iconWrap.className = 'mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4 shadow-sm ring-4 ring-white relative z-10 bg-amber-100';
                icon.className = 'fas fa-spinner text-3xl';
                icon.style.color = 'var(--status-pending)';
                icon.classList.add('animate-spin');
                title.textContent = 'Payment Pending';
                dot.className = 'w-2 h-2 rounded-full bg-amber-400 animate-pulse';
                dotText.className = 'text-xs text-amber-400 font-medium';
                dotText.textContent = 'Pending';
            }
        }

        function bindData() {
            const rawTs = qs('timestamp', String(Date.now()));
            // Check if timestamp is numeric (epoch) or string date
            const ts = /^\d+$/.test(rawTs) ? Number(rawTs) : rawTs;
            const dt = new Date(ts);
            const tsEl = document.getElementById('status-timestamp');
            
            if (isNaN(dt.getTime())) {
                 tsEl.textContent = rawTs; // Fallback to raw string if parsing fails
            } else {
                 tsEl.textContent = dt.toLocaleDateString(undefined, { month: 'short', day: '2-digit', year: 'numeric' }) + ' â€¢ ' + dt.toLocaleTimeString();
            }
            
            document.getElementById('amount').textContent = qs('tokenAmount', qs('amount', '0'));
            document.getElementById('symbol').textContent = qs('symbol', 'TOKEN');
            document.getElementById('service').textContent = qs('service', 'Airtime Purchase');
            document.getElementById('provider').textContent = qs('provider', 'Provider');
            document.getElementById('recipient').textContent = qs('recipient', '');
            document.getElementById('fiatValue').textContent = qs('fiatValue', '');
            
            const ref = qs('reference', '');
            document.getElementById('reference').textContent = ref;
            document.getElementById('reference-copy').onclick = function() {
                copyToClipboard(ref, 'Reference');
            };
            
            const token = qs('token', '');
            const sender = qs('sender', '');
            const target = qs('target', '');
            
            document.getElementById('token-symbol').textContent = qs('symbol', '');
            document.getElementById('token-short').textContent = formatShort(token);
            document.getElementById('sender-short').textContent = formatShort(sender);
            document.getElementById('target-short').textContent = formatShort(target);
            
            document.getElementById('sender-copy').onclick = function() {
                copyToClipboard(sender, 'Sender Address');
            };
            document.getElementById('target-copy').onclick = function() {
                copyToClipboard(target, 'Target Address');
            };
            
            const txh = qs('txHash', '');
            document.getElementById('tx-hash').textContent = txh;
            document.getElementById('tx-copy').onclick = function() {
                copyToClipboard(txh, 'Tx Hash');
            };
        }
        
        function init() {
            setStatusFromQuery();
            bindData();
            
            // Save Image Button
            document.getElementById('save-image-btn').onclick = function() {
                const root = document.getElementById('receipt-root');
                const btnSave = document.getElementById('save-image-btn');
                const btnPrint = document.getElementById('print-btn');
                
                // Temporarily hide buttons for capture
                btnSave.style.display = 'none';
                btnPrint.style.display = 'none';
                
                html2canvas(root, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true
                }).then(canvas => {
                    // Restore buttons
                    btnSave.style.display = 'flex';
                    btnPrint.style.display = 'flex';
                    
                    // Download image
                    const link = document.createElement('a');
                    link.download = 'receipt-' + Date.now() + '.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Close tab after short delay
                    setTimeout(() => window.close(), 1000);
                }).catch(err => {
                    console.error(err);
                    alert('Failed to save image');
                    btnSave.style.display = 'flex';
                    btnPrint.style.display = 'flex';
                });
            };
            
            // Print Button
            document.getElementById('print-btn').onclick = function() {
                const root = document.getElementById('receipt-root');
                const btnSave = document.getElementById('save-image-btn');
                const btnPrint = document.getElementById('print-btn');
                
                // Temporarily hide buttons for print
                btnSave.style.display = 'none';
                btnPrint.style.display = 'none';
                
                window.print();
                
                // Restore buttons after print dialog closes
                // Note: window.print() is blocking in many browsers, but not all.
                // We use a small timeout or the 'afterprint' event if needed, 
                // but here we just restore immediately as execution resumes after print dialog.
                btnSave.style.display = 'flex';
                btnPrint.style.display = 'flex';
                
                // Close tab after print
                setTimeout(() => window.close(), 500);
            };
            
            try {
                sessionStorage.setItem('lastReceiptParams', window.location.search);
            } catch(e) {
                // Ignore storage errors
            }
        }
        
        // Initialize when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
